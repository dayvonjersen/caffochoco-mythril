<link rel='import' href='/bower_components/polymer/polymer-element.html'>

<link rel='import' href='/bower_components/app-route/app-route.html'>

<link rel='import' href='/bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='/bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='/bower_components/paper-slider/paper-slider.html'>

<link rel='import' href='/caffo-playlist-item.html'>

<dom-module id='caffo-release'>
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        height: 100%;
        text-align: left;
      }

      h1 {
        font-size: 2rem;
        margin: 0;
        padding: .5rem;
      }

      h2 {
        margin: .5rem 1.5rem;
        line-height: 1;
        font-size: 1.25rem;
      }

      paper-tabs {
        text-transform: uppercase;
        clear: both;
        --paper-tab-ink: var(--vibrant, #000);
        --paper-tabs-selection-bar-color: var(--vibrant, #000);
      }

      paper-icon-button {
        --paper-icon-button-ink-color: var(--vibrant);
      }

      .info {
        background: var(--darkmuted, #333);
        color: var(--darkmuted-text, #aaa);
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        padding: 1em;
      }

      header {
        background: var(--darkmuted, rgba(252,252,252,0.8));
        color: var(--darkmuted-text, #000);
      }

      header img {
        width: 100%;
        max-height: 8rem;
        transition: 0.35s all 0.1s ease-in-out;
        object-fit: cover;
      }

      header img:hover {
        max-height: 100vh;
      }

      .gone {
        display: none;
      }

      .content {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: .5rem;
        box-shadow: 0px 12px 10px -10px var(--darkmuted, #000) inset,
                    0px -12px 10px -10px var(--darkmuted, #000) inset;
      }

      sorbetto-spektrum {
        display: block;
        height: 3rem;
        color: var(--lightvibrant, #555);
        border-color: var(--vibrant, red);
        filter: drop-shadow(0 0 64px);
      }

      paper-icon-button {
        display: inline-block;
        background: var(--vibrant, #ccc);
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
        border-radius: 50%;
      }

      #playpauseBtn {
        width: 60px;
        height: 60px;
      }

      #previousBtn, #nextBtn, #muteBtn {
        width: 28px;
        height: 28px;
        vertical-align: middle;
        margin-left: .25rem;
      }

      #muteBtn {
        margin-right: -1.25rem;
      }

      .controls {
        padding: .5rem;
        display: flex;
        justify-content: space-between;
      }
      .controls > div {
        display: flex;
        align-items: center;
      }
      .controls paper-slider {
        width: 5.25rem;
        display: inline-block;
        vertical-align: middle;
        padding: 0 1.25rem 0 1rem;
        --paper-progress-active-color: var(--vibrant);
        --paper-slider-knob-color: var(--vibrant);
      }
    </style>

    <app-route
      route='{{route}}'
      pattern='/:tabName'
      data='{{data}}'>
    </app-route>

    <header>
      <div>
        <a id='albumartlink' target='_blank'><img id='thumbnail'></a>
        <h2>[[release.artist]]</h2>
        <h1>&ldquo;[[release.title]]&rdquo;</h1>
        <sorbetto-spektrum id="spektrum"></sorbetto-spektrum>
        <div class='controls'>
          <div>
            <paper-icon-button id="playpauseBtn" on-click="_playpause" elevation="3" src="/svg/play.svg"></paper-icon-button>
            <paper-icon-button id="previousBtn" on-click="_previous" elevation="2" src="/svg/fast-backward.svg"></paper-icon-button>
            <paper-icon-button id="nextBtn" on-click="_next" elevation="2" src="/svg/fast-forward.svg"></paper-icon-button>
          </div>
          <div>
            <paper-icon-button id="muteBtn" on-click="_toggleMute" elevation="0" src="/svg/volume-mute.svg"></paper-icon-button>
            <paper-slider id="volume" on-immediate-value-change="_setVolume" min="0" max="100"></paper-slider>
          </div>
        </div>
      </div>

      <paper-tabs selected='{{selectedTab}}' on-iron-select='_tabChanged'>
        <paper-tab>info</paper-tab>
        <dom-repeat items='{{tracklists}}'>
          <template>
            <paper-tab data-tracklist$='[[item.id]]'>[[item.title]]</paper-tab>
          </template>
        </dom-repeat>
      </paper-tabs>
    </header>

    <div class='content' id='releaseInfo'></div>
    <div class='content' id='tracklist'></div>

    <footer>
      <div class='info'>
        <span class='year'>[[release.year]]</span>
        <span class='genre'>#[[release.genre]]</span>
        <span class='total'>[[total]]</span>
      </div>
    </footer>
  </template>
  <script>
class CaffoRelease extends Polymer.Element {
  static get is() { return 'caffo-release'; }
  static get properties() {
    return {
      route: {
        type: Object,
        notify: true
      }
    };
  }
  static get observers() {
    return [
      '_pageChanged(data.tabName)'
    ];
  }

  _playpause() {
    player.togglePlayback();
  }

  _previous() {
    player.previous();
  }

  _next() {
    player.next();
  }

  _toggleMute() {
    player.toggleMute();
    this.$.volume.value = player.currentVolume;
  }

  _setVolume() {
    if(player.currentVolume !== this.$.volume.immediateValue) {
      player.setVolume(this.$.volume.immediateValue);
    }
  }

  _loadTracklist(tracklist) {
    if(!player) return;

    let total = 0;
    for(let i = 0; i < this.tracklists.length; i++) {
      if(this.tracklists[i].id == tracklist) {
        let skip = false;
        if(tracklist == player.state.tracklistId) {
          skip = true;
        } else {
          player.clear();
        }
        this.tracklists[i].tracks.forEach((t) => {
          total += t.length;
          let url = this._formatUrl(t.file);
          if(player.nowPlaying != url) {
            if(!skip) player.add(url);
          } else if(skip) {
            skip = false;
          }
        });
        break;
      }
    }
    this.total = formatTime(total);
    this._render(tracklist);
  }

  _render(tracklistId) {
    let tracklist = this.tracklists.find(tl=>tl.id == tracklistId);
    if(!tracklist) return;
    this.$.tracklist.innerHTML = '';
    tracklist.tracks.forEach(item => {
      let playlistItem = document.createElement('caffo-playlist-item');
      playlistItem.setAttribute('tracklist-id', item.tracklistId);
      playlistItem.setAttribute('title', item.title);
      playlistItem.setAttribute('length', item.length);
      playlistItem.setAttribute('url', this._formatUrl(item.file));
      this.$.tracklist.appendChild(playlistItem);
    });
  }

  _pageChanged(name) {
    if(!('_caffoCache' in window && window._caffoCache.has(name)))  return;
    this.release = _caffoCache.get(name);

    fetch('/image/'+this.release.url+'.jpg.css')
      .then(response=>response.json())
      .then(json=>this.updateStyles(json))
      .catch(err=>console.error(err))

    this.$.thumbnail.src = '/image/'+this.release.url+'.jpg';
    this.$.albumartlink.href = '/image/'+this.release.url+'.jpg';
    document.title = this.release.title;

    this.$.releaseInfo.innerHTML = this.release.info;

    this.tracklists = this.release.tracklists;
    for(let i = 0; i < this.release.tracklists.length; i++) {
      if(this.release.defaultTracklist === this.release.tracklists[i].id) {
        this.selectedTab = i+1;
        break;
      }
    }
    this._loadTracklist(this.release.defaultTracklist);
    if(player) {
      player.togglePlayback();
    } else {
      this.willPlay = true;
    }
  }

  _formatUrl(url) {
    return `/audio/${this.release.url}/${url}`;
  }

  _tabChanged(event) {
    if(!event.detail.item.dataset.tracklist) {
      this.$.releaseInfo.classList.remove('gone');
      this.$.tracklist.classList.add('gone');
    } else {
      this.$.releaseInfo.classList.add('gone');
      this.$.tracklist.classList.remove('gone');
      let e = Polymer.dom(event);
      this._loadTracklist(parseInt(e.localTarget.selectedItem.dataset.tracklist));
      if(this.willPlay) {
        player.togglePlayback();
        this.willPlay = undefined;
      }
    }
  }

  notify(playerState) {
    this.$.playpauseBtn.src = playerState.isPlaying ? '/svg/pause.svg' : '/svg/play.svg';
    this.$.muteBtn.src = playerState.currentVolume == 0 ? '/svg/volume-mute.svg' : (playerState.currentVolume > 50 ? '/svg/volume-full.svg' : '/svg/volume-mid.svg');
    if(playerState.nowPlayingIndex == 0) {
      this.$.previousBtn.classList.add('gone');
    } else {
      this.$.previousBtn.classList.remove('gone');
    }
    if(playerState.nowPlayingIndex == playerState.playlist.length - 1) {
      this.$.nextBtn.classList.add('gone');
    } else {
      this.$.nextBtn.classList.remove('gone');
    }
    this.$.spektrum.bars = 64;
    this.$.spektrum.padY = 0;
  }

  connectedCallback() {
    super.connectedCallback();
    this.$.volume.value = parseInt(player.audioElement.volume * 100);
    [].forEach.call(
      this.shadowRoot.querySelectorAll("caffo-playlist-item"),
      (item) => player.subject.add(item)
    );
    player.subject.add(this);
  }
}
customElements.define(CaffoRelease.is, CaffoRelease);
  </script>
</dom-module>
