<link rel='import' href='/bower_components/polymer/polymer-element.html'>

<link rel='import' href='/bower_components/app-route/app-route.html'>

<link rel='import' href='/bower_components/iron-pages/iron-pages.html'>

<link rel='import' href='/bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='/bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='/bower_components/paper-slider/paper-slider.html'>

<dom-module id='caffo-release'>
  <template>
    <style>
      :host{
        background: var(--darkmuted, rgba(252,252,252,0.8));
        color: var(--darkmuted-text, #000);
      }
      paper-slider {
        --paper-slider-container-color: var(--vibrant-text);
        --paper-slider-active-color: var(--vibrant);
        --paper-slider-knob-color: var(--vibrant);
        --paper-slider-pin-color: var(--vibrant);
        --paper-slider-font-color: var(--vibrant-text);
      }
      paper-tabs {
        text-transform: uppercase;
        --paper-tab-ink: var(--vibrant, #000);
        --paper-tabs-selection-bar-color: var(--vibrant, #000);
      }
      paper-icon-button {
        --paper-icon-button-ink-color: var(--vibrant);
      }
      .year {
        color: #aaa;
      }
      iron-pages {
        display: flex;
        min-height: 0;
      }
      iron-pages > * {
        width: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        scroll-behavior: smooth;
        padding: 16px;
      }
      header div {
        padding: 0 1em;
      }
      .tracklist ol {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .tracklist li  {
        display: flex;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
        padding: 1em 0.5em;
        position: relative;
      }
      .tracklist li paper-slider {
        position: absolute;
        width: calc(100% + 32px);
        left: -16px;
        bottom: -16px;
        --paper-slider-height: 3px;
      }
      .tracklist li img {
        width: 2.3333em;
        height: 2.3333em;
      }
      .tracklist .title {
        flex: 1;
        padding: 0 .5em;
      }
    </style>

    <link rel='stylesheet' href='/image/[[release.url]].jpg.css'>
    <app-route
      route='{{route}}'
      pattern='/:tabName'
      data='{{data}}'>
    </app-route>

    <header class='mdl-shadow--2dp'>
      <div>
        <!-- info -->
        <h1 id='releaseTitle'>[[release.title]]</h1>
        <span class='year'>[[release.year]]</span>
        <span class='genre'>[[release.genre]]</span>

        <!-- actions -->
        <paper-icon-button src='/svg/download.svg'></paper-icon-button>
      </div>

      <!-- tabs -->
      <paper-tabs selected='{{selectedTab}}' on-iron-select='_tabChanged'>
        <paper-tab>info</paper-tab>
        <dom-repeat items='{{tracklists}}'>
          <template>
            <paper-tab data-tracklist$='[[item.id]]'>[[item.title]]</paper-tab>
          </template>
        </dom-repeat>
      </paper-tabs>
    </header>

    <iron-pages selected='{{selectedTab}}'>
      <div id='releaseInfo'></div>
      <dom-repeat items='{{tracklists}}'>
        <template>
          <div class='tracklist'>
            <ol>
              <dom-repeat items='{{item.tracks}}'>
                <template>
                  <li>
                    <img src='/svg/play.svg'>
                    <span class='title'>{{item.title}}</span>
                    <span>[[_formatTime(item.length)]]</span>
                  </li>
                </template>
              </dom-repeat>
              <li class='mdl-shadow--dp8'>
                <img src='/svg/pause.svg'>
                <span class='title'>example</span>
                <span>4:20</span>
                <paper-slider pin min='10' max='200' value='110'></paper-slider>
              </li>
            </ol>
          </div>
        </template>
      </dom-repeat>
    </iron-pages>

    <footer>
      <!-- total time, volume controls? etc... -->
    </footer>
  </template>
  <script>
class CaffoRelease extends Polymer.Element {
  static get is() { return 'caffo-release'; }
  static get config() {
    return {
      properties: {
        route: {
          type: Object,
          notify: true
        },
        tracklists: {
          type: Array,
        }
      },
      observers: [
        '_pageChanged(data.tabName)'
      ],
    }
  }

  _formatTime(time) {
    return formatTime(time);
  }

  _pageChanged(name) {
    if(!('_caffoCache' in window && window._caffoCache.has(name)))  return;
    this.release = _caffoCache.get(name);
    setBackground('/image/'+this.release.url+'.jpg');
    this.tracklists = this.release.tracklists;
    this.selectedTab = this.release.defaultTracklist+1;
    this.$.releaseInfo.innerHTML = this.release.info;
    document.title = this.release.title;
  }

  _tabChanged(event, details) {
    let tracklist = details.item.dataset.tracklist;
    if(tracklist === "") return;
    for(let i = 0; i < this.tracklists.length; i++) {
      if(this.tracklists[i].id == tracklist) {
        player.clear();
        this.tracklists[i].tracks.forEach(t => player.add(`/audio/${this.release.url}/${t.file}`));
      }
    }
  }

  connectedCallback() {
    super.connectedCallback();
  }
}
customElements.define(CaffoRelease.is, CaffoRelease);
  </script>
</dom-module>
