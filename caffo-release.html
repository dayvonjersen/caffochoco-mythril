<link rel='import' href='/bower_components/polymer/polymer-element.html'>

<link rel='import' href='/bower_components/app-route/app-route.html'>

<link rel='import' href='/bower_components/paper-dialog/paper-dialog.html'>
<link rel='import' href='/bower_components/paper-icon-button/paper-icon-button.html'>
<link rel='import' href='/bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='/bower_components/paper-slider/paper-slider.html'>

<link rel='import' href='/caffo-playlist-item.html'>

<dom-module id='caffo-release'>
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        height: 100%;
        text-align: left;
      }

      h1 {
        font-size: 2rem;
        margin: 0;
        padding: .5rem;
      }

      h2 {
        margin: .5rem 1.5rem;
        line-height: 1;
        font-size: 1.25rem;
      }

      paper-tabs {
        text-transform: uppercase;
        clear: both;
        --paper-tab-ink: var(--vibrant, #000);
        --paper-tabs-selection-bar-color: var(--vibrant, #000);
      }

      paper-icon-button {
        --paper-icon-button-ink-color: var(--vibrant);
      }

      .info {
        color: var(--darkmuted-text, #aaa);
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        padding: 1em;
      }

      header {
        background: var(--darkmuted, rgba(252,252,252,0.8));
        color: var(--darkmuted-text, #000);
      }

      header img {
        width: 100%;
        max-height: 8rem;
        transition: 0.35s all 0.1s ease-in-out;
        object-fit: cover;
      }

      header img:hover {
        max-height: 100vh;
      }

      .gone {
        display: none;
      }

      .content {
        flex: 1;
        overflow-y: scroll;
        min-height: 0;
      }
    </style>

    <app-route
      route='{{route}}'
      pattern='/:tabName'
      data='{{data}}'>
    </app-route>

    <header>
      <div>
        <a id='albumartlink' target='_blank'><img id='thumbnail'></a>
        <h2>[[release.artist]]</h2>
        <h1>&ldquo;[[release.title]]&rdquo;</h1>
        <div class='info'>
          <span class='year'>[[release.year]]</span>
          <span class='genre'>#[[release.genre]]</span>
          <span class='total'>[[total]]</span>
        </div>
      </div>

      <!-- tabs -->
      <paper-tabs selected='{{selectedTab}}' on-iron-select='_tabChanged'>
        <paper-tab>info</paper-tab>
        <dom-repeat items='{{tracklists}}'>
          <template>
            <paper-tab data-tracklist$='[[item.id]]'>[[item.title]]</paper-tab>
          </template>
        </dom-repeat>
      </paper-tabs>
    </header>

    <div class='content' id='releaseInfo'></div>
    <div class='content' id='tracklist'></div>

    <footer>
      <paper-icon-button src='/svg/download.svg'></paper-icon-button>
    </footer>
  </template>
  <script>
class CaffoRelease extends Polymer.Element {
  static get is() { return 'caffo-release'; }
  static get config() {
    return {
      properties: {
        route: {
          type: Object,
          notify: true
        },
      },
      observers: [
        '_pageChanged(data.tabName)'
      ],
    }
  }

  _loadTracklist(tracklist) {
    if(!player) return;

    let total = 0;
    for(let i = 0; i < this.tracklists.length; i++) {
      if(this.tracklists[i].id == tracklist) {
        player.clear();
        let skip = false;
        if(tracklist == player.state.tracklistId) {
          skip = true;
        }
        this.tracklists[i].tracks.forEach((t) => {
          total += t.length;
          let url = this._formatUrl(t.file);
          if(player.nowPlaying != url) {
            if(!skip) player.add(url);
          } else if(skip) {
            skip = false;
          }
        });
        break;
      }
    }
    this.total = formatTime(total);
    this._render(tracklist);
  }

  _render(tracklistId) {
    let tracklist = this.tracklists.find(tl=>tl.id == tracklistId);
    if(!tracklist) return;
    this.$.tracklist.innerHTML = '';
    tracklist.tracks.forEach(item => {
      let playlistItem = document.createElement('caffo-playlist-item');
      playlistItem.setAttribute('tracklist-id', item.tracklistId);
      playlistItem.setAttribute('title', item.title);
      playlistItem.setAttribute('length', item.length);
      playlistItem.setAttribute('url', this._formatUrl(item.file));
      this.$.tracklist.appendChild(playlistItem);
    });
  }

  _pageChanged(name) {
    if(!('_caffoCache' in window && window._caffoCache.has(name)))  return;
    this.release = _caffoCache.get(name);

    fetch('/image/'+this.release.url+'.jpg.css')
      .then(response=>response.json())
      .then(json=>this.updateStyles(json))
      .catch(err=>console.error(err))

    this.$.thumbnail.src = '/image/'+this.release.url+'.jpg';
    this.$.albumartlink.href = '/image/'+this.release.url+'.jpg';
    document.title = this.release.title;

    this.$.releaseInfo.innerHTML = this.release.info;

    this.tracklists = this.release.tracklists;
    for(let i = 0; i < this.release.tracklists.length; i++) {
      if(this.release.defaultTracklist === this.release.tracklists[i].id) {
        this.selectedTab = i+1;
        break;
      }
    }
    this._loadTracklist(this.release.defaultTracklist);
    if(player) {
      player.togglePlayback();
    } else {
      this.willPlay = true;
    }
  }

  _formatUrl(url) {
    return `/audio/${this.release.url}/${url}`;
  }

  _tabChanged(event) {
    if(!event.detail.item.dataset.tracklist) {
      this.$.releaseInfo.classList.remove('gone');
      this.$.tracklist.classList.add('gone');
    } else {
      this.$.releaseInfo.classList.add('gone');
      this.$.tracklist.classList.remove('gone');
      let e = Polymer.dom(event);
      this._loadTracklist(parseInt(e.localTarget.selectedItem.dataset.tracklist));
      if(this.willPlay) {
        player.togglePlayback();
        this.willPlay = undefined;
      }
    }
  }

  connectedCallback() {
    super.connectedCallback();
    [].forEach.call(
      this.shadowRoot.querySelectorAll("caffo-playlist-item"),
      (item) => player.subject.add(item)
    );
  }
}
customElements.define(CaffoRelease.is, CaffoRelease);
  </script>
</dom-module>
